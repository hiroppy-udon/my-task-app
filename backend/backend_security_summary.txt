バックエンド構成と脆弱性サマリ
=================================

日付: 2026-02-14
リポジトリ: my-task-app

1) 構成の要約
- フレームワーク: FastAPI（エンドポイント: /convert, /sync）。実行入口は `backend/main.py`。
- 音声処理: `pydub` による mp4->wav 変換。その後 `RVCInfer` により音声変換（`backend/infer_rvc.py`）。
- モデル/資産: `models/zundamon.pth`, `models/zundamon.index`, `hubert_base.pt` などの学習済みファイルを利用。
- 起動: 仮想環境有効化後に `python3 main.py`（`backend/start.sh` に記述）。`uvicorn.run(... host="0.0.0.0", port=8000)` で公開。
- 永続化: 単一 JSON ファイル `database.json` を読み書きして同期データを保持（`/sync`）。
- 依存: `requirements.txt` に `faiss-cpu`, `torch`, `transformers`, `fastapi`, `uvicorn` 等多数。

2) 確認された主な脆弱性・運用リスク（優先度順）
- 認証・公開制御がない（高）: `/convert` と `/sync` が認証なしで公開されている。
- CORS がワイルドカード（高）: `allow_origins=["*"]` により任意オリジンからのアクセスを許可。
- 固定テンポラリファイル名（高）: `input_voice.mp4`, `input_ready.wav`, `output_zunda.wav` といった固定名の使用で同時リクエスト競合や情報混濁のリスク。
- アップロード検証不足（高）: ファイルタイプ/サイズ/実行時間の制限がないため DoS やディスク枯渇の可能性。
- DB（JSON）書き込みの競合（中）: `database.json` を排他制御せずに読み書きしているためレースコンディションや破損の恐れ。
- 入力データの信頼性欠如（中）: `/sync` でクライアントデータをそのまま上書きする可能性があり、検証が不十分。
- レート制限・リソース制御なし（中）: リクエスト頻度制限がないためサービス妨害に脆弱。
- モデル／インデックス改竄リスク（中）: モデルファイルが適切に保護されていないとポイズニングリスクがある。
- ログ/情報露出（低）: 起動時に QR/URL をターミナルに出力する実装があり、運用ミスで情報漏えいの可能性。
- 依存の脆弱性（低〜中）: 多数のライブラリに既知の脆弱性が含まれる可能性（定期的な監査が必要）。
- サンドボックス不足（低）: 変換処理がアプリ内で直接実行され、外部入力からの副作用を隔離していない。

3) 具体的な改善案（優先度付き）
即時対応（高）:
- 認証追加: `/convert` と `/sync` に API キーまたは JWT 認証を導入。
- CORS 制限: `allow_origins` をフロントの正しい URL のみに固定。
- テンポラリ名を一意化: `tempfile` や UUID ベースのファイル名を使用し、処理ごとに隔離、確実に削除する。
- アップロード制限: MIME タイプ検証、最大サイズ (例: 5–20MB)、タイムアウトの設定。

優先度中:
- DB 書き込みの排他制御: `portalocker` 等でファイルロック、または SQLite 等への移行。
- `/sync` の検証強化: マージルールを厳密化（タイムスタンプ・署名など）。
- レート制限: IP/APIキー ごとのレート制限を導入（リバースプロキシやミドルウェアで）。
- 非同期処理化: 変換はワーカー／ジョブキューに委譲して同期ブロッキングを避ける。

中長期（推奨）:
- サンドボックス化: 音声変換をコンテナや限定権限プロセスで実行。
- モデルファイル保護: 読み取り専用配置、ハッシュ/署名検証、外部からの上書き禁止。
- 監査ログ・アラート: 異常アクセスの記録と通知。
- 依存管理: パッケージ固定（pin）、脆弱性スキャンの自動化。
- ネットワーク設計: `uvicorn` は可能なら `127.0.0.1` バインドしトンネル/プロキシ経由で公開。

4) まずやること（チェックリスト）
- API 認証を追加する
- `allow_origins` を固定する
- アップロードのサイズ・MIME 制限を設ける
- 一意のテンポラリファイル名に変更する（`tempfile` の利用）
- `database.json` 書き込みにファイルロックを導入

5) 追加の実施提案（実装のヒント）
- FastAPI での簡易 APIKey: `fastapi.security.APIKeyHeader` を導入し、環境変数でキーを管理。
- 一時ファイル: Python の `tempfile.NamedTemporaryFile(delete=False)` や `uuid.uuid4()` を用いる。
- ファイルロック: `portalocker` を `requirements.txt` に追加し、読み書き時に排他ロックする。
- レート制限: `slowapi` やリバースプロキシ（Cloudflare、nginx）で導入。
- 非同期: `background_tasks` や Celery/RQ を使い長時間処理はジョブ化する。

必要なら、これらのうち優先項目を私が実装してパッチ化します。どれから進めますか？
